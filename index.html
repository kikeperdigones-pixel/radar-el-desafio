<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Radar</title>
  <style>
    body{margin:0;font-family:Segoe UI,Arial;background:#0f1115;color:#e6e6e6}
    header{padding:20px;border-bottom:1px solid #222;font-weight:600;font-size:20px}
    .cornerMark{position:fixed;top:20px;right:30px;font-size:12px;letter-spacing:4px;font-weight:700;color:#e10600;opacity:.85}
    .container{max-width:1000px;margin:auto;padding:20px}
    .card{background:#171a21;border:1px solid #222;border-radius:14px;padding:14px;margin-bottom:12px;cursor:pointer}
    button{background:#222;border:1px solid #333;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;margin-top:8px}
    button:hover{background:#2a2f3a}
    .hidden{display:none}
    video{width:100%;margin-top:10px;border-radius:10px}
    h2{margin:14px 0 10px 0}
    input{margin-top:8px}
  </style>
</head>
<body>
  <div class="cornerMark">EL DESAFÍO</div>
  <header>Radar</header>

  <div class="container">
    <div id="season"></div>
    <div id="program" class="hidden"></div>
    <div id="test" class="hidden"></div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const supabase = createClient(
      "https://xjqqjhwuosfvqclqoxdh.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqcXFqaHd1b3NmdnFjbHFveGRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MTE0MzksImV4cCI6MjA4NjQ4NzQzOX0.B9bDCyCe3WeV5cxlSfEHKtkr7IfrWJPvPoLsrJ8cDP4"
    );

    const programs = [
      {
        code: "P01",
        date: "27 Feb",
        tests: [
          { name: "Baile Botellas agua y foco", contestant: "Elvira" },
          { name: "Escapismo Cemento", contestant: "Joan Capdevila" },
          { name: "Coche pasa por esquina", contestant: "Amelia Bono" },
          { name: "Instrumento pailas", contestant: "Mujer X" },
          { name: "Fuego arrastra coche", contestant: "Miguel Ángel Muñoz" },
          { name: "Aéreo estructura neones", contestant: "Lara Álvarez" },
          { name: "Tiro arco colgado", contestant: "Canco Rodríguez" },
          { name: "Apnea", contestant: "Raúl López" }
        ]
      }
    ];

    const seasonEl = document.getElementById("season");
    const programEl = document.getElementById("program");
    const testEl = document.getElementById("test");

    const show = (el) => el.classList.remove("hidden");
    const hide = (el) => el.classList.add("hidden");

    function safeFolderName(name){
      return name
        .replace(/[^\w\s\-áéíóúüñÁÉÍÓÚÜÑ]/g, "")
        .trim()
        .replace(/\s+/g, "_");
    }

    function renderSeason() {
      seasonEl.innerHTML = "";
      programs.forEach((p, i) => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `<b>${p.code}</b> · ${p.date}<br>${p.tests.length} pruebas`;
        div.onclick = () => openProgram(i);
        seasonEl.appendChild(div);
      });
    }

    function openProgram(index) {
      hide(seasonEl);
      hide(testEl);
      show(programEl);

      const p = programs[index];
      programEl.innerHTML = `<button id="backSeason">← Volver</button><h2>${p.code} · ${p.date}</h2>`;

      document.getElementById("backSeason").onclick = () => {
        hide(programEl);
        show(seasonEl);
      };

      p.tests.forEach((t, i) => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `<b>${t.name}</b><br>${t.contestant}`;
        div.onclick = () => openTest(index, i);
        programEl.appendChild(div);
      });
    }

    function openTest(pIndex, tIndex) {
      hide(programEl);
      show(testEl);

      const p = programs[pIndex];
      const t = p.tests[tIndex];

      testEl.innerHTML = `
        <button id="backProgram">← Volver</button>
        <h2>${t.name}</h2>
        <div>${t.contestant}</div>
        <input type="file" id="fileInput" accept="video/*" />
        <button id="uploadBtn">Subir ensayo</button>
        <div id="videos"></div>
      `;

      document.getElementById("backProgram").onclick = () => openProgram(pIndex);
      document.getElementById("uploadBtn").onclick = () => uploadVideo(p.code, t.name);

      loadVideos(p.code, t.name);
    }

    async function uploadVideo(programCode, testName) {
      const input = document.getElementById("fileInput");
      const file = input.files?.[0];
      if (!file) return alert("Selecciona un vídeo");

      const folder = `${programCode}/${safeFolderName(testName)}`;
      const fileSafe = file.name.replace(/\s+/g, "_");
      const path = `${folder}/${Date.now()}_${fileSafe}`;

      const { error } = await supabase.storage.from("videos").upload(path, file);
      if (error) return alert("Error al subir: " + error.message);

      input.value = "";
      await loadVideos(programCode, testName);
    }

    async function loadVideos(programCode, testName) {
      const folder = `${programCode}/${safeFolderName(testName)}`;

      const { data, error } = await supabase.storage.from("videos").list(folder, { limit: 50 });
      if (error) return;

      const container = document.getElementById("videos");
      container.innerHTML = "";

      (data || []).forEach((f) => {
        const { data: urlData } = supabase.storage.from("videos").getPublicUrl(`${folder}/${f.name}`);
        container.innerHTML += `<video controls src="${urlData.publicUrl}"></video>`;
      });
    }

    renderSeason();
  </script>
</body>
</html>
