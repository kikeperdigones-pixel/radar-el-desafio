<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Radar</title>
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const supabase = createClient(
    "https://xjqqjhwuosfvqclqoxdh.supabase.co",
    "TU_ANON_KEY"
  );

  // …y debajo de esto pega el resto de tu JS tal cual lo tenías,
  // pero elimina esta línea si existe:
  // const supabase = window.supabase.createClient(...)
</script>
  <style>
body{margin:0;font-family:Segoe UI,Arial;background:#0f1115;color:#e6e6e6}
header{padding:20px;border-bottom:1px solid #222;font-weight:600;font-size:20px}
.cornerMark{position:fixed;top:20px;right:30px;font-size:12px;letter-spacing:4px;font-weight:700;color:#e10600;opacity:.8}
.container{max-width:1000px;margin:auto;padding:20px}
.card{background:#171a21;border:1px solid #222;border-radius:14px;padding:14px;margin-bottom:12px;cursor:pointer}
button{background:#222;border:1px solid #333;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;margin-top:8px}
button:hover{background:#2a2f3a}
.hidden{display:none}
video{width:100%;margin-top:10px;border-radius:10px}
</style>
</head>
<body>
<div class="cornerMark">EL DESAFÍO</div>
<header>Radar</header>
<div class="container">
<div id="season"></div>
<div id="program" class="hidden"></div>
<div id="test" class="hidden"></div>
</div>

<script>
const supabase = window.supabase.createClient(
  "https://xjqqjhwuosfvqclqoxdh.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqcXFqaHd1b3NmdnFjbHFveGRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MTE0MzksImV4cCI6MjA4NjQ4NzQzOX0.B9bDCyCe3WeV5cxlSfEHKtkr7IfrWJPvPoLsrJ8cDP4"
);

let programs=[{
code:"P01",
date:"27 Feb",
tests:[
{name:"Baile Botellas agua y foco",contestant:"Elvira"},
{name:"Escapismo Cemento",contestant:"Joan Capdevila"},
{name:"Coche pasa por esquina",contestant:"Amelia Bono"},
{name:"Instrumento pailas",contestant:"Mujer X"},
{name:"Fuego arrastra coche",contestant:"Miguel Ángel Muñoz"},
{name:"Aéreo estructura neones",contestant:"Lara Álvarez"},
{name:"Tiro arco colgado",contestant:"Canco Rodríguez"},
{name:"Apnea",contestant:"Raúl López"}
]}];

function renderSeason(){
const container=document.getElementById("season");
container.innerHTML="";
programs.forEach((p,i)=>{
let div=document.createElement("div");
div.className="card";
div.innerHTML=`<b>${p.code}</b> · ${p.date}<br>${p.tests.length} pruebas`;
div.onclick=()=>openProgram(i);
container.appendChild(div);
});
}

function openProgram(index){
document.getElementById("season").classList.add("hidden");
let container=document.getElementById("program");
container.classList.remove("hidden");
let p=programs[index];
container.innerHTML=`<button onclick="backToSeason()">← Volver</button><h2>${p.code}</h2>`;
p.tests.forEach((t,i)=>{
let div=document.createElement("div");
div.className="card";
div.innerHTML=`<b>${t.name}</b><br>${t.contestant}`;
div.onclick=()=>openTest(index,i);
container.appendChild(div);
});
}

function openTest(pIndex,tIndex){
document.getElementById("program").classList.add("hidden");
let container=document.getElementById("test");
container.classList.remove("hidden");
let test=programs[pIndex].tests[tIndex];

container.innerHTML=`
<button onclick="openProgram(${pIndex})">← Volver</button>
<h2>${test.name}</h2>
<input type="file" id="fileInput" accept="video/*">
<button onclick="uploadVideo('${programs[pIndex].code}','${test.name}')">Subir ensayo</button>
<div id="videos"></div>
`;

loadVideos(programs[pIndex].code,test.name);
}

async function uploadVideo(programCode,testName){
const file=document.getElementById("fileInput").files[0];
if(!file) return alert("Selecciona un vídeo");

const path=`${programCode}/${testName}/${Date.now()}_${file.name}`;

const { error } = await supabase.storage
.from('videos')
.upload(path,file);

if(error){ alert("Error al subir"); return; }

alert("Subido correctamente");
loadVideos(programCode,testName);
}

async function loadVideos(programCode,testName){
const { data } = await supabase.storage
.from('videos')
.list(`${programCode}/${testName}`);

const container=document.getElementById("videos");
container.innerHTML="";

if(!data) return;

for(let file of data){
const { data: urlData } = supabase.storage
.from('videos')
.getPublicUrl(`${programCode}/${testName}/${file.name}`);

container.innerHTML+=`<video controls src="${urlData.publicUrl}"></video>`;
}
}

function backToSeason(){
document.getElementById("program").classList.add("hidden");
document.getElementById("season").classList.remove("hidden");
}

renderSeason();
</script>
</body>
</html>
